# Voice Agent Debug Diagnostics - ACTIVE

## Current Status
- **New voice agent process running**: PID 31884 (started 16:01)
- **Old process killed**: PID 25751 (was interfering)
- **Extensive logging added**: Ready to capture all agent routing

## What Was Added

### 1. Startup Logging
When the voice agent starts (on room connection), you'll see:
```
ğŸš€ ========================================
ğŸš€ VOICE AGENT INITIALIZATION
ğŸš€ Target Agent Name: Agent_66
ğŸš€ Target Agent ID (from env): agent-4dfca708-49a8-4982-8e36-0f1146f9a66e
ğŸš€ ========================================
```

### 2. Agent Selection Message Logging
When UI sends agent selection, you'll see:
```
ğŸ“¨ ========================================
ğŸ“¨ DATA RECEIVED FROM CLIENT
ğŸ“¨ Raw data: {"type":"agent_selection",...}
ğŸ“¨ ========================================
ğŸ“¨ Message type: agent_selection
ğŸ“¨ ========================================
ğŸ“¨ AGENT SELECTION MESSAGE RECEIVED
ğŸ“¨ Agent ID: agent-4dfca708-...
ğŸ“¨ Agent Name: Agent_66
ğŸ“¨ Current Assistant Agent ID: agent-xxx...
ğŸ“¨ ========================================
```

### 3. Agent Switch Process Logging
When agent switch is attempted:
```
ğŸ”„ ========================================
ğŸ”„ AGENT SWITCH REQUEST RECEIVED
ğŸ”„ Current Agent ID: [current]
ğŸ”„ Requested Agent ID: [new]
ğŸ”„ Requested Agent Name: Agent_66
ğŸ”„ Switching Allowed: True
ğŸ”„ Primary Agent Name: Agent_66
ğŸ”„ ========================================
```

### 4. Query Processing Logging
Every user query shows:
```
ğŸ¤ ========================================
ğŸ¤ NEW QUERY RECEIVED
ğŸ¤ User message: [query text]
ğŸ¤ Current Agent ID: [active agent]
ğŸ¤ Current Agent Name: Agent_66
ğŸ¤ Memory Loaded: True/False
ğŸ¤ ========================================
```

### 5. Memory Loading Logging
When agent memory is loaded:
```
ğŸ§  LOADING MEMORY - Agent ID: agent-4dfca708-...
ğŸ§  LOADING MEMORY - Agent Name: Agent_66
ğŸ§  Retrieving agent details from Letta for ID: agent-4dfca708-...
ğŸ§  Retrieved agent: Agent_66 (ID: agent-4dfca708-...)
```

### 6. Response Generation Logging
Every response includes:
```
âœ… Total llm_node latency: X.XXs
âœ… RESPONSE GENERATED BY AGENT: agent-4dfca708-...
```

### 7. **CRITICAL: Voice Agent Now Announces Agent ID**
Every response will be prefixed with:
```
[DEBUG: Using Agent ID 1146f9a6]
```

This will be spoken by the voice agent, so you'll HEAR which agent it's using!

## How to Test

### Step 1: Connect to Voice Agent
1. Open: http://localhost:9000/voice-agent-selector-debug.html
2. Select Agent_66
3. Click Connect
4. **Wait for connection confirmation**

### Step 2: Monitor Logs
In a terminal, run:
```bash
./monitor_debug.sh
```

This will show real-time debug info highlighting:
- Agent initialization
- Agent selection messages
- Agent switches
- Query processing
- Memory loading
- Responses

### Step 3: Send Test Query
Ask the voice agent ANY question, such as:
- "What do you know about this project?"
- "Who are you?"
- "What is your purpose?"

### Step 4: Analyze Results

#### Look for in logs:
1. **Was agent selection message received?**
   - Look for "ğŸ“¨ AGENT SELECTION MESSAGE RECEIVED"
   - Does it show the correct Agent_66 ID?

2. **Was agent switch attempted?**
   - Look for "ğŸ”„ AGENT SWITCH REQUEST RECEIVED"
   - Was it accepted or rejected?

3. **Which agent is processing queries?**
   - Look for "ğŸ¤ Current Agent ID" in query logs
   - Does it match Agent_66's ID?

4. **Is memory being loaded?**
   - Look for "ğŸ§  LOADING MEMORY"
   - Does it load Agent_66's memory?

5. **Which agent generated the response?**
   - Look for "âœ… RESPONSE GENERATED BY AGENT"
   - Listen for the spoken agent ID prefix

#### Listen for in voice response:
- **You should HEAR**: "[DEBUG: Using Agent ID 1146f9a6]" at the start of EVERY response
- The last 8 characters of Agent_66's ID are: **1146f9a6**
- If you hear a different ID, that's the problem!

## Likely Scenarios

### Scenario A: Agent Selection Message Not Received
**Symptoms**: No "ğŸ“¨ AGENT SELECTION MESSAGE RECEIVED" in logs
**Diagnosis**: UI is not sending the message, or it's being sent to wrong room/participant
**Fix**: Check UI JavaScript sending logic

### Scenario B: Agent Switch Rejected
**Symptoms**: "âŒ REJECTED - Agent switch" in logs
**Diagnosis**: Agent name mismatch or switching disabled
**Fix**: Check PRIMARY_AGENT_NAME and allow_agent_switching settings

### Scenario C: Agent Switch Accepted But Wrong Agent Used
**Symptoms**: Switch logs show success, but queries use different agent
**Diagnosis**: Race condition or agent_id not persisting
**Fix**: Check if agent_id is being reset somewhere

### Scenario D: Memory Not Loading
**Symptoms**: "ğŸ§  LOADING MEMORY" fails or shows wrong agent
**Diagnosis**: Letta API issue or wrong agent_id
**Fix**: Verify agent exists in Letta and ID is correct

### Scenario E: Multiple Processes Interfering
**Symptoms**: Inconsistent behavior, logs don't match reality
**Diagnosis**: Multiple voice agent processes running (ALREADY FIXED)
**Fix**: Kill all processes and start fresh (DONE)

## Quick Diagnostics Commands

```bash
# Monitor logs in real-time
./monitor_debug.sh

# Check full logs
tail -f voice_agent_debug.log

# Search for specific events
grep "ğŸ¤ Current Agent ID" voice_agent_debug.log | tail -20
grep "ğŸ”„ AGENT SWITCH" voice_agent_debug.log
grep "ğŸ“¨ AGENT SELECTION" voice_agent_debug.log
grep "ğŸ§  LOADING MEMORY" voice_agent_debug.log

# Check which agent is being used
grep "âœ… RESPONSE GENERATED BY AGENT" voice_agent_debug.log | tail -10

# Verify only one process is running
ps aux | grep letta_voice | grep -v grep
```

## Expected Agent_66 ID
```
Full ID: agent-4dfca708-49a8-4982-8e36-0f1146f9a66e
Last 8 chars: 1146f9a6
```

## Next Steps

1. **Connect to voice agent** via debug UI
2. **Run monitor script**: `./monitor_debug.sh`
3. **Ask a question** and listen for the agent ID
4. **Review logs** to see exactly where the routing breaks
5. **Report findings** with specific log excerpts

The debug prefix in voice responses will make it IMMEDIATELY obvious which agent is being used!
